name: Build AltAppStore IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Prepare Swift package structure
        run: |
          mkdir -p AltAppStore/Sources
          mv *.swift Models Views ViewModels Assets.xcassets Info.plist LaunchScreen.storyboard AltAppStore/Sources/ || true
          cd AltAppStore
          cat > Package.swift <<'EOF'
          // swift-tools-version: 5.7
          import PackageDescription

          let package = Package(
              name: "AltAppStore",
              platforms: [.iOS(.v16)],
              products: [
                  .executable(name: "AltAppStore", targets: ["AltAppStore"])
              ],
              targets: [
                  .executableTarget(
                      name: "AltAppStore",
                      path: "Sources",
                      resources: [
                          .process("Assets.xcassets"),
                          .process("LaunchScreen.storyboard")
                      ]
                  )
              ]
          )
          EOF

      - name: Build archive
        run: |
          cd AltAppStore
          swift build -c release
          mkdir -p ../build/Payload
          cp -r .build/release/AltAppStore.app ../build/Payload/
          cd ../build
          zip -r AltAppStore.ipa Payload

      - name: Upload unsigned IPA to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build/AltAppStore.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
