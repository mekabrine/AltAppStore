name: Build AltAppStore IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Xcode project dynamically
        run: |
          mkdir -p AltAppStore/Sources
          touch AltAppStore/Sources/main.swift
          echo 'print("AltAppStore build start")' > AltAppStore/Sources/main.swift
          cat > AltAppStore/Package.swift <<EOF
          // swift-tools-version: 5.10
          import PackageDescription
          let package = Package(
              name: "AltAppStore",
              platforms: [.iOS(.v16)],
              products: [.executable(name: "AltAppStore", targets: ["AltAppStore"])],
              targets: [.executableTarget(name: "AltAppStore")]
          )
          EOF

      - name: Build archive (iOS target)
        run: |
          cd AltAppStore
          xcodebuild -scheme AltAppStore -sdk iphoneos -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            archive -archivePath ../build/AltAppStore.xcarchive || true

          swift build -c release --triple arm64-apple-ios16.0 || true

          mkdir -p ../build/Payload
          find .build -type d -name "*.app" -exec cp -r {} ../build/Payload/AltAppStore.app \; || true
          cd ../build
          zip -r AltAppStore.ipa Payload || true

      - name: Upload unsigned IPA artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: AltAppStore-unsigned
          path: build/AltAppStore.ipa
