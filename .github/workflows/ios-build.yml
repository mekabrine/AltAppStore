name: Build AltAppStore IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create Xcode project dynamically
        run: |
          mkdir -p AltAppStore
          mv *.swift Models Views ViewModels Assets.xcassets Info.plist LaunchScreen.storyboard AltAppStore/ || true
          cd AltAppStore
          swift package init --type executable
          rm -f Package.swift
          cat > Package.swift <<'EOF'
          // swift-tools-version: 5.7
          import PackageDescription

          let package = Package(
              name: "AltAppStore",
              platforms: [.iOS(.v16)],
              targets: [
                  .executableTarget(
                      name: "AltAppStore",
                      path: ".",
                      resources: [
                          .process("Assets.xcassets"),
                          .process("LaunchScreen.storyboard")
                      ]
                  )
              ]
          )
          EOF
          cd ..
          xcodebuild -create-xcodeproj -projectName AltAppStore AltAppStore

      - name: Build unsigned IPA
        run: |
          xcodebuild -project AltAppStore.xcodeproj \
            -scheme AltAppStore \
            -sdk iphoneos \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            archive -archivePath $PWD/build/AltAppStore.xcarchive

          xcodebuild -exportArchive \
            -archivePath $PWD/build/AltAppStore.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath $PWD/build

      - name: Upload unsigned IPA to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
