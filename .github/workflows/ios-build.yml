name: Build AltAppStore IPA

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Prepare Swift package structure
        run: |
          mkdir -p AltAppStore/Sources
          mv *.swift Models Views ViewModels Assets.xcassets Info.plist LaunchScreen.storyboard AltAppStore/Sources/ || true
          cd AltAppStore
          cat > Package.swift <<'EOF'
          // swift-tools-version: 5.7
          import PackageDescription

          let package = Package(
              name: "AltAppStore",
              platforms: [.iOS(.v16)],
              products: [
                  .executable(name: "AltAppStore", targets: ["AltAppStore"])
              ],
              targets: [
                  .executableTarget(
                      name: "AltAppStore",
                      path: "Sources",
                      resources: [
                          .process("Assets.xcassets"),
                          .process("LaunchScreen.storyboard")
                      ]
                  )
              ]
          )
          EOF

      - name: Build archive (iOS target)
        run: |
          cd AltAppStore
          # Build for iOS device (arm64)
          xcodebuild \
            -scheme AltAppStore \
            -sdk iphoneos \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            archive -archivePath ../build/AltAppStore.xcarchive || true

          # Fallback: compile manually for iOS if no xcodeproj
          swift build -c release --triple arm64-apple-ios16.0 || true

          mkdir -p ../build/Payload
          # Try to locate built .app bundle (SwiftPM may produce binary)
          find .build -type d -name "*.app" -exec cp -r {} ../build/Payload/AltAppStore.app \; || true
          cd ../build
          zip -r AltAppStore.ipa Payload || true

      - name: Upload unsigned IPA to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build/AltAppStore.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
